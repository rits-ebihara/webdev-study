# JavaScript での非同期処理

## 概要

非同期処理とは、１つの処理を実行中に、別の処理を並行して実行するものです。

Webアプリケーションでは、サーバー、クライアントどちらも非同期処理が多く出てきます。

サーバーサイドでは、他のサービスやデータベースなどの I/O の処理で、クライアントサでは、バックグラウンドで サーバーと通信するときなど、登場するシーンは多いです。

非同期処理の扱い方を学んでおくのは、必須と言えるでしょう。

また、JavaScript では 他の言語やプラットフォーム異なり、非同期の仕組みが特殊ですので、そのあたりも解説します。

## シングルスレッド と ノンブロッキング I/O

JavaScript は（というようりも、Node.js や ブラウザでのスクリプトエンジンでは、という方が正しいですが便宜上ここではこう表現します）、シングルスレッドで動作します。

シングルスレッドで動作する、ということは、処理が１つしか実行できないということです。

しかし、JavaScript では非同期のメソッド作成できます。これは、ノンブロッキング I/O という仕組みがあるためです。

通常のマルチスレッドを使った非同期処理の場合は、下記のようなイメージです。

料理をするときに、スレッドごとにシェフが居て、それぞれの作業を行う感じですね。恵まれた職場環境です。

![マルチスレッド](multi-thread.drawio.png)

JavaScript の場合、時間がかかる I/O の処理が終わるまで待つ（ブロックする）のではなく、その間に別の処理を行います。

シェフが一人で、作業の待ちの時間を使って他の作業をやる感じです。ワンオペです。ブラックな職場環境かな？

![ノンブロッキングI/O](non-blocking-io.drawio.png)

実際、マルチスレッドのほうが、処理効率は高いです。ただ、スレッドを増やすことは、PCの負荷に影響します。スレッドが作成できる上限もあります。

Webサーバーのようにたくさんのリクエストがある場合、それらはある程度同時に実行しなければなりません。

リクエストごとにスレッドを作るのが理想ですが、多くなりすぎると PCの負荷が高くなりサーバー全体が重くなってしまい、各リクエストの処理がすべて遅くなってしまいます。

ノンブロッキングI/O のWebサーバーではリクエストが増えても、「空き時間に処理する」という仕組みにより、PC自体が重くなりにくく、結果的に多くのリクエストを処理できるようになります。

> 実は マルチスレッドでも、OS や プラットフォーム のレベルで処理を分割して、シーケンシャルに処理されています。  
> ですが、マルチスレッドをプログラムで扱う時には、「同時に処理される」位の速さなので、その認識で良いです。  
> マルチプロセスは、より同時処理の考え方に近いです。（CPUコアレベルで、分割される）  
> マルチプロセスのほうが、PCへの負荷はさらに高いです。

## setTimeout, setInterval

ブラウザ上の JavaScript で、昔からある非同期処理でメジャーなものが、`setTimeout` `setInterval` です。


