# Webアプリケーションのテスト

## 概要

ここでは、Webアプリケーションのテストについて解説します。

テスト全般の話と、主に Unit Test として書かれるテストプログラムとそれに使用するテストフレームワークについて、説明します。

## テストの種類

テストには、通常、テストの範囲、目的によって「単体」「結合(統合)」「総合」と分け方をすることが多いですが、場合によっては４区分くらいに分ける場合もあります。

また、プロジェクトによって同じ名称でも内容が異なることがあるので、チームで明示的に定義する必要があります。

ちなみに、下記書籍で Google でのソフトウェア開発におけるテストでは、上記の呼称ではなく、small, medium, large, enormous(巨大な) の指針の例として、下記が挙げられています。

[テストから見えてくる グーグルのソフトウェア開発 | ジェームズ・ウィテカー, ジェーソン・アーボン, ジェフ・キャローロ, 長尾高弘 |本 | 通販 | Amazon](https://www.amazon.co.jp/%E3%83%86%E3%82%B9%E3%83%88%E3%81%8B%E3%82%89%E8%A6%8B%E3%81%88%E3%81%A6%E3%81%8F%E3%82%8B-%E3%82%B0%E3%83%BC%E3%82%B0%E3%83%AB%E3%81%AE%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E9%96%8B%E7%99%BA-%E3%82%B8%E3%82%A7%E3%83%BC%E3%83%A0%E3%82%BA%E3%83%BB%E3%82%A6%E3%82%A3%E3%83%86%E3%82%AB%E3%83%BC/dp/482228512X)

(書籍からの要約です。(補足)　は、海老原の所感です。)

- small
    - 環境から切り離してコード単一の振る舞いをチェックする。たとえばクラスや関数単位のでテスト。
    - Googleの社外では一般的には「単体テスト」と呼ばれる。
    - 大規模テストでは到達不可能なところまで包括的にカバーする。
    - 外部のサービス、モジュールはモックとし、外部依存がないものとする。
        - (補足)外部とはテスト対象のモジュールではないもの。JavaScriptのプロジェクトではモジュール ≒ ファイル。  
      とはいえ、文字列変換など単純なユーティリティ的なものはモック化しないことも。  
      その場合でも、自作のユーティリティであれば、それ自体も単体でテストする。
    - 頻繁に実行され高速に実行できること。
    - 実装と同時にテストコードを書いていく必要がある。
        - (補足)コーディング -> テスト記述 ->  実行 -> コーディング を繰り返す。

- medium
    - 複数のモジュール間のやり取りをチェックする。
    - Googleの社外では一般的には「統合テスト」と呼ばれる。
    - small テストより範囲が広く、時間もかかる。
    - モジュールの限られたサブセットとの間のやり取りをテストする。
    - 対象以外のモジュールはモック化することが多い。
        - (補足)localhost で実行される DB などに接続することなどはある。
    - 実行タイミングは、small よりもまばら。
        - (補足)自動テストができれば、1日に1回くらいか。
        - (補足)手動であれば、実装、small テストが終わった段階で、など。

- large, enormous
    - システム全体が正しく動作しているかをチェックする。
        - (補足)複数のシステムで1つの要件を満たす場合など、個々のシステムのテストを large、全体を enormous とすることになるかと思う。
        - (補足)コンテナによるモジュール化、マイクロサービス化が進むと、どのテストレベルでどういった組み合わせを行うかの検討が必要。
    - 環境は本番と同じか近いもので、モックは使うことはない。
    - 外部のサービスなどのリソースを使うこともある。
        - (補足)large では、軽量フェイクのサービス、enormous は、先方が用意しているの検証環境といった区別があるかと思う。
    - 基本的に手動で時間のかかるテストとなる。
        - (補足)実行のタイミングは、リリース前が考えられる

これらの区分は、Google 内でもプロジェクトや製品ごとに細かく違うそうで、作っているものの性質、チームメンバーのスキルなどに合わせて定義する必要があります。

ここでは、テストの呼称を上の small, medium, large, enormous として呼ぶこととします。

## テストの自動化

継続してメンテナンスするアプリケーションについては、各テストレベルでは、できる限り自動テストを実行すべきです。

"問題が、人間の直感や習慣、思考に関するものでなければ自動化すべし"と Google の指針でも謳っています。

テスト規模が小さくなるほど、機械で判断できる事が多いと思うので、smallテストでは、現在はテストを書くことが必須である、という認識でいるべきでしょう。

## JavaScript / TypeScript における small テストの実施

JavaScript に限らず、テストコードを書いたり実施するには、効率化のためテストフレームワークを利用することが多いです。

テストフレームワークでは下記のような機能を提供します。

- テストの記述ルール
- モック作成
- 評価・結果の表示
- ブラウザなどUIのシミュレート
- カバレッジ

基本的に、ブラウザなどUIを使用せず、シェル上で動作することが必要です。そうすることで Git にプルリクした時や、リリース前に自動でテストを流す、ということができるからです。

JavaScript / TypeScript 用のテストフレームワークは、いくつかありますが、Jest と呼ばれるものが最も使用されていると思います。

[Jest · 🃏 Delightful JavaScript Testing](https://jestjs.io/ja/#:~:text=Jest%20%E3%81%AF%E3%81%82%E3%82%89%E3%82%86%E3%82%8B%20JavaScript%20%E3%81%AE,%E3%83%86%E3%82%B9%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%A7%E3%81%99%E3%80%82)

特徴として下記があるとおもいます。

- 必要なものがワンパッケージになっている。
- モックが書きやすい。
- 結果が見やすい。

